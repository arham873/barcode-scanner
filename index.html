<script src="https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/umd/index.min.js"></script>
<script>
  const video = document.getElementById('video');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  const last = document.getElementById('last');
  const log = document.getElementById('log');
  const facing = document.getElementById('facing');
  const labelInput = document.getElementById('label');
  const webhookInput = document.getElementById('webhook');

  let codeReader;
  let stream;
  let lastCode = null;
  let cooldown = false;
  let track;
  let capabilities;
  let zoomLevel = 1;

  // Buat slider zoom
  const zoomControl = document.createElement('input');
  zoomControl.type = 'range';
  zoomControl.step = '0.1';
  zoomControl.value = 1;
  zoomControl.style.width = '200px';
  zoomControl.style.marginTop = '10px';
  document.querySelector('main').appendChild(zoomControl);

  // Buat tombol torch (lampu)
  const torchButton = document.createElement('button');
  torchButton.textContent = 'Torch ðŸ”¦';
  torchButton.style.marginTop = '5px';
  document.querySelector('main').appendChild(torchButton);

  function appendLog(text){
    const t = document.createElement('div');
    t.textContent = '[' + new Date().toLocaleTimeString() + '] ' + text;
    log.prepend(t);
  }

  async function requestCameraPermission(){
    try {
      const constraints = { 
        video: { 
          facingMode: { ideal: facing.value },
          width: { ideal: 640 }, 
          height: { ideal: 480 },
          focusMode: 'continuous' // auto focus
        } 
      };
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;
      await video.play();

      // ambil track kamera
      track = stream.getVideoTracks()[0];
      capabilities = track.getCapabilities();

      // setup zoom control
      if (capabilities.zoom) {
        zoomControl.min = capabilities.zoom.min ?? 1;
        zoomControl.max = capabilities.zoom.max ?? 10;
        zoomControl.value = track.getSettings().zoom || 1;

        zoomControl.oninput = () => {
          zoomLevel = parseFloat(zoomControl.value);
          track.applyConstraints({ advanced: [{ zoom: zoomLevel }] });
        };
      } else {
        zoomControl.disabled = true;
      }

      // setup torch
      if (capabilities.torch) {
        torchButton.onclick = async () => {
          const settings = track.getSettings();
          const torchOn = !settings.torch;
          try {
            await track.applyConstraints({ advanced: [{ torch: torchOn }] });
            appendLog(torchOn ? 'Torch dinyalakan' : 'Torch dimatikan');
          } catch (e) {
            appendLog('Torch tidak didukung: ' + e.message);
          }
        };
      } else {
        torchButton.disabled = true;
      }

      appendLog('Kamera aktif');
      return true;
    } catch (err) {
      appendLog('Izin kamera ditolak: ' + err.message);
      alert('Harap izinkan akses kamera agar pemindaian dapat berjalan.');
      return false;
    }
  }

  async function startScanner(){
    const ok = await requestCameraPermission();
    if(!ok) return;

    codeReader = new ZXing.BrowserMultiFormatReader();
    appendLog('Scanner siap membaca Barcode dan QR...');

    try {
      codeReader.decodeFromVideoDevice(null, video, (result, err) => {
        if(result){
          onDetected(result.getText());
        }
      });
    } catch(e){
      appendLog('Gagal mulai scanner: ' + e.message);
    }
  }

  function stopScanner(){
    try{
      if(codeReader){codeReader.reset(); codeReader = null;}
      if(stream){stream.getTracks().forEach(t=>t.stop()); stream=null;}
      video.srcObject=null;
      appendLog('Scanner dihentikan');
    }catch(e){appendLog('Error stop: '+e.message)}
  }

  function onDetected(code){
    if(cooldown && code===lastCode) return;
    lastCode=code;
    last.textContent='Hasil: '+code;
    appendLog('Terdeteksi: '+code);

    cooldown=true;
    setTimeout(()=>cooldown=false,1500);

    const webhook=webhookInput.value.trim();
    if(webhook){postToWebhook({value:code,label:labelInput.value||'',timestamp:new Date().toISOString()});}
  }

  async function postToWebhook(payload){
    try{
      const webhook=webhookInput.value.trim();
      if(!webhook){appendLog('Webhook belum diisi');return;}
      const res=await fetch(webhook,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      const txt=await res.text();
      appendLog('Response: '+txt);
    }catch(e){appendLog('Gagal kirim: '+e.message);}
  }

  startBtn.addEventListener('click',startScanner);
  stopBtn.addEventListener('click',stopScanner);
  facing.addEventListener('change',()=>{if(stream)stopScanner();startScanner();});

  appendLog('Siap. Tekan "Mulai" untuk mulai pemindaian.');
</script>
