<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Scanner QR & Barcode Responsif</title>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #f2f2f2;
      margin: 0;
      padding: 0;
    }
    #reader {
      width: 320px;
      height: 240px;
      margin: 20px auto;
      border: 2px solid #444;
      border-radius: 10px;
      background: #000;
    }
    #captureCanvas {
      display: none;
    }
    button, select, input[type=range] {
      margin: 5px;
      padding: 10px 15px;
      border-radius: 8px;
      border: none;
      font-size: 16px;
    }
    button:hover {
      background: #ddd;
    }
    #controls {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>Scanner QR & Barcode</h2>
  <div>
    <select id="mode">
      <option value="scan">Scan Langsung</option>
      <option value="capture">Capture Dulu</option>
    </select>
  </div>
  <div id="reader"></div>
  <canvas id="captureCanvas"></canvas>
  <div id="controls">
    <button id="startBtn">Mulai</button>
    <button id="stopBtn">Stop</button>
    <button id="captureBtn">Capture</button>
    <label>Zoom: <input type="range" id="zoomSlider" min="1" max="5" step="0.1" value="1"></label>
    <button id="torchBtn">Torch</button>
  </div>
  <p id="result">Hasil: -</p>
  <script>
    let html5QrCode;
    let currentStream;
    let currentTrack;
    let torchOn = false;

    async function startScanner() {
      const mode = document.getElementById('mode').value;
      const reader = document.getElementById('reader');
      const constraints = {
        video: {
          facingMode: 'environment',
          width: { ideal: 640 },
          height: { ideal: 480 },
          focusMode: 'continuous',
          zoom: true
        }
      };

      try {
        currentStream = await navigator.mediaDevices.getUserMedia(constraints);
        currentTrack = currentStream.getVideoTracks()[0];

        // Autofocus
        const capabilities = currentTrack.getCapabilities();
        if (capabilities.focusMode) {
          await currentTrack.applyConstraints({ advanced: [{ focusMode: 'continuous' }] });
        }

        // Pasang zoom control
        const zoomSlider = document.getElementById('zoomSlider');
        if (capabilities.zoom) {
          zoomSlider.min = capabilities.zoom.min;
          zoomSlider.max = capabilities.zoom.max;
          zoomSlider.step = capabilities.zoom.step || 0.1;
          zoomSlider.value = currentTrack.getSettings().zoom || 1;
          zoomSlider.oninput = async (e) => {
            await currentTrack.applyConstraints({ advanced: [{ zoom: e.target.value }] });
          };
        } else {
          zoomSlider.disabled = true;
        }

        // Torch
        const torchBtn = document.getElementById('torchBtn');
        if (capabilities.torch) {
          torchBtn.onclick = async () => {
            torchOn = !torchOn;
            await currentTrack.applyConstraints({ advanced: [{ torch: torchOn }] });
          };
        } else {
          torchBtn.disabled = true;
        }

        if (mode === 'scan') {
          html5QrCode = new Html5Qrcode("reader");
          html5QrCode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 250, height: 250 } },
            (decodedText) => {
              document.getElementById('result').innerText = `Hasil: ${decodedText}`;
            },
            (errorMessage) => {}
          );
        } else {
          const video = document.createElement('video');
          reader.innerHTML = '';
          reader.appendChild(video);
          video.srcObject = currentStream;
          video.play();
          document.getElementById('captureBtn').onclick = async () => {
            const canvas = document.getElementById('captureCanvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            const imageData = canvas.toDataURL('image/png');

            const qrCode = new Html5Qrcode("reader");
            qrCode.scanFileV2(canvas).then(decodedText => {
              document.getElementById('result').innerText = `Hasil: ${decodedText}`;
              qrCode.clear();
            }).catch(err => {
              document.getElementById('result').innerText = 'Tidak terdeteksi.';
            });
          };
        }
      } catch (err) {
        alert('Gagal mengakses kamera: ' + err);
      }
    }

    function stopScanner() {
      if (html5QrCode) html5QrCode.stop().catch(() => {});
      if (currentStream) currentStream.getTracks().forEach(t => t.stop());
      document.getElementById('reader').innerHTML = '';
    }

    document.getElementById('startBtn').onclick = startScanner;
    document.getElementById('stopBtn').onclick = stopScanner;
  </script>
</body>
</html>
